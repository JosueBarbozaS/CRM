@model IngeTechCRM.Models.Usuario
@{
    ViewData["Title"] = "Mi Perfil";
    var provincias = ViewBag.Provincias as List<Provincia>;
    var selectedProvinciaId = Model?.ID_PROVINCIA;
}

<div class="container mx-auto px-4 py-6">
    <!-- ✅ MENSAJES DE BIENVENIDA PARA NUEVOS USUARIOS -->
    @if (TempData["WelcomeMessage"] != null)
    {
        <div class="mb-6 rounded-xl bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500 p-6 shadow-lg">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <div class="flex h-10 w-10 items-center justify-center rounded-full bg-green-100">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                </div>
                <div class="ml-4 flex-1">
                    <h3 class="text-lg font-bold text-green-800">@TempData["WelcomeMessage"]</h3>
                    @if (TempData["IsNewUser"] != null)
                    {
                        <p class="mt-2 text-sm text-green-700">
                            <i class="fas fa-lightbulb mr-1"></i>
                            <strong>¡Consejo!</strong> Completa tu información personal a continuación para disfrutar de una experiencia personalizada.
                            Los campos marcados con <span class="text-red-500">*</span> son obligatorios.
                        </p>
                        <div class="mt-3 flex items-center text-sm text-green-600">
                            <i class="fas fa-shield-alt mr-2"></i>
                            Tu información está segura y protegida con nosotros.
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    @if (TempData["InfoMessage"] != null)
    {
        <div class="mb-6 rounded-xl bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 p-4 shadow-md">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-500 text-xl"></i>
                </div>
                <div class="ml-3">
                    <p class="text-blue-800 font-medium">@TempData["InfoMessage"]</p>
                </div>
            </div>
        </div>
    }

    <!-- ❌ REMOVIDO: No duplicar mensajes que ya se muestran en _Layout.cshtml -->

    <h1 class="mb-6 text-2xl font-bold text-gray-800 md:text-3xl">Mi Perfil</h1>

    <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
        <!-- Información Personal -->
        <div class="overflow-hidden rounded-xl bg-white shadow-lg">
            <div class="bg-gradient-to-r from-indigo-600 to-blue-500 px-4 py-3 text-white">
                <h2 class="font-bold">Información Personal</h2>
            </div>
            <div class="p-6">
                <div class="mb-6 flex flex-col items-center">
                    <div class="mb-3 flex h-24 w-24 items-center justify-center rounded-full bg-indigo-100 text-indigo-600">
                        <i class="fas fa-user-circle text-5xl"></i>
                    </div>
                    <h3 class="mb-1 text-xl font-bold text-gray-800">@Model.NOMBRE_COMPLETO</h3>
                    <span class="rounded-full bg-indigo-100 px-3 py-1 text-sm font-medium text-indigo-600">@Model.TipoUsuario.DESCRIPCION</span>
                </div>

                <div class="mb-4 h-px w-full bg-gray-200"></div>

                <div class="space-y-3 text-gray-700">
                    <div class="flex">
                        <span class="w-1/3 font-semibold">Usuario:</span>
                        <span class="w-2/3">@Model.NOMBRE_USUARIO</span>
                    </div>
                    <div class="flex">
                        <span class="w-1/3 font-semibold">ID:</span>
                        <span class="w-2/3">@Model.IDENTIFICACION</span>
                    </div>
                    <div class="flex">
                        <span class="w-1/3 font-semibold">Correo:</span>
                        <span class="w-2/3 break-words">@Model.CORREO_ELECTRONICO</span>
                    </div>
                    <div class="flex">
                        <span class="w-1/3 font-semibold">Teléfono:</span>
                        <span class="w-2/3">
                            @if (string.IsNullOrEmpty(Model.TELEFONO))
                            {
                                <span class="text-orange-600 italic">⚠️ Pendiente</span>
                            }
                            else
                            {
                                @Model.TELEFONO
                            }
                        </span>
                    </div>
                    <div class="flex">
                        <span class="w-1/3 font-semibold">Provincia:</span>
                        <span class="w-2/3">
                            @if (Model.Provincia != null)
                            {
                                @Model.Provincia.NOMBRE
                            }
                            else
                            {
                                <span class="text-orange-600 italic">⚠️ Pendiente</span>
                            }
                        </span>
                    </div>
                    <div class="flex">
                        <span class="w-1/3 font-semibold">Dirección:</span>
                        <span class="w-2/3">
                            @if (string.IsNullOrEmpty(Model.DIRECCION_COMPLETA))
                            {
                                <span class="text-orange-600 italic">⚠️ Pendiente</span>
                            }
                            else
                            {
                                @Model.DIRECCION_COMPLETA
                            }
                        </span>
                    </div>
                    @if (Model.FECHA_NACIMIENTO.HasValue)
                    {
                        <div class="flex">
                            <span class="w-1/3 font-semibold">Nacimiento:</span>
                            <span class="w-2/3">@Model.FECHA_NACIMIENTO.Value.ToString("dd/MM/yyyy")</span>
                        </div>
                    }
                    <div class="flex">
                        <span class="w-1/3 font-semibold">Registro:</span>
                        <span class="w-2/3">@Model.FECHA_REGISTRO.ToString("dd/MM/yyyy")</span>
                    </div>
                    <div class="flex">
                        <span class="w-1/3 font-semibold">Último acceso:</span>
                        <span class="w-2/3">@Model.ULTIMO_ACCESO.ToString("dd/MM/yyyy HH:mm")</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenido principal: 2 columnas restantes -->
        <div class="space-y-6 lg:col-span-2">
            <!-- Formulario de actualización de datos -->
            <div class="overflow-hidden rounded-xl bg-white shadow-lg">
                <div class="bg-gradient-to-r from-indigo-600 to-blue-500 px-4 py-3 text-white">
                    <h2 class="font-bold">Actualizar Datos</h2>
                    @if (TempData["IsNewUser"] != null)
                    {
                        <p class="text-sm opacity-90 mt-1">
                            <i class="fas fa-star mr-1"></i>
                            Completa tu información para personalizar tu experiencia
                        </p>
                    }
                </div>
                <div class="p-6">
                    <form method="post" action="@Url.Action("ActualizarPerfil", "Account")" id="perfilForm">
                        <input type="hidden" name="Identificacion" value="@Model.IDENTIFICACION" />
                        <input type="hidden" name="CorreoElectronico" value="@Model.CORREO_ELECTRONICO" />
                        <input type="hidden" name="FechaRegistro" value="@Model.FECHA_REGISTRO" />
                        <input type="hidden" name="UltimoAcceso" value="@Model.ULTIMO_ACCESO" />
                        <input type="hidden" name="IdTipoUsuario" value="@Model.ID_TIPO_USUARIO" />

                        <div class="mb-4">
                            <label for="NombreUsuario" class="mb-2 block text-sm font-medium text-gray-700">
                                Nombre de Usuario <span class="text-red-500">*</span>
                            </label>
                            <input type="text"
                                   class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                                   id="NombreUsuario"
                                   name="NombreUsuario"
                                   value="@Model.NOMBRE_USUARIO"
                                   required
                                   minlength="3"
                                   maxlength="50">
                            <div id="error-nombreUsuario" class="hidden mt-1 text-xs text-red-600">
                                El nombre de usuario es obligatorio (mínimo 3 caracteres)
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="NombreCompleto" class="mb-2 block text-sm font-medium text-gray-700">
                                Nombre Completo <span class="text-red-500">*</span>
                            </label>
                            <input type="text"
                                   class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                                   id="NombreCompleto"
                                   name="NombreCompleto"
                                   value="@Model.NOMBRE_COMPLETO"
                                   onkeypress="return soloLetrasYTildes(event)"
                                   oninput="validarNombreCompleto(this)"
                                   required
                                   minlength="2"
                                   maxlength="100">
                            <div id="error-nombre" class="hidden mt-1 text-xs text-red-600">
                                Solo se permiten letras, tildes y espacios (mínimo 2 caracteres)
                            </div>
                        </div>

                        <div class="mb-4 grid grid-cols-1 gap-4 md:grid-cols-2">
                            <div>
                                <label for="Telefono" class="mb-2 block text-sm font-medium text-gray-700">
                                    Teléfono <span class="text-red-500">*</span>
                                    @if (string.IsNullOrEmpty(Model.TELEFONO))
                                    {
                                        <span class="text-orange-600 text-xs">⚠️ Requerido</span>
                                    }
                                </label>
                                <input type="tel"
                                       class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring focus:ring-indigo-200 focus:ring-opacity-50 @(string.IsNullOrEmpty(Model.TELEFONO) ? "border-orange-300 bg-orange-50" : "")"
                                       id="Telefono"
                                       name="Telefono"
                                       value="@Model.TELEFONO"
                                       onkeypress="return soloNumeros(event)"
                                       oninput="validarTelefono(this)"
                                       onpaste="return validarPegado(event)"
                                       required
                                       minlength="8"
                                       maxlength="8"
                                       pattern="[0-9]{8}"
                                       placeholder="Ej: 12345678">
                                <div id="error-telefono" class="hidden mt-1 text-xs text-red-600">
                                    Solo se permiten números (8 dígitos)
                                </div>
                            </div>
                            <div>
                                <label for="IdProvincia" class="mb-2 block text-sm font-medium text-gray-700">
                                    Provincia <span class="text-red-500">*</span>
                                    @if (Model.ID_PROVINCIA == 1)
                                    {
                                        <span class="text-orange-600 text-xs">⚠️ Seleccione su provincia</span>
                                    }
                                </label>
                                <select class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring focus:ring-indigo-200 focus:ring-opacity-50 @(Model.ID_PROVINCIA == 1 ? "border-orange-300 bg-orange-50" : "")"
                                        id="IdProvincia"
                                        name="IdProvincia"
                                        required>
                                    <option value="">Seleccione una provincia</option>
                                    @foreach (var provincia in provincias)
                                    {
                                        var selectedAttribute = selectedProvinciaId == provincia.ID_PROVINCIA ? " selected" : "";
                                        @Html.Raw($"<option value='{provincia.ID_PROVINCIA}'{selectedAttribute}>{provincia.NOMBRE}</option>")
                                    }
                                </select>
                                <div id="error-provincia" class="hidden mt-1 text-xs text-red-600">
                                    Debe seleccionar una provincia
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="DireccionCompleta" class="mb-2 block text-sm font-medium text-gray-700">
                                Dirección Completa <span class="text-red-500">*</span>
                                @if (string.IsNullOrEmpty(Model.DIRECCION_COMPLETA))
                                {
                                    <span class="text-orange-600 text-xs">⚠️ Requerido</span>
                                }
                            </label>
                            <textarea class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring focus:ring-indigo-200 focus:ring-opacity-50 @(string.IsNullOrEmpty(Model.DIRECCION_COMPLETA) ? "border-orange-300 bg-orange-50" : "")"
                                      id="DireccionCompleta"
                                      name="DireccionCompleta"
                                      rows="3"
                                      required
                                      minlength="10"
                                      maxlength="250"
                                      placeholder="Ej: 100 metros al norte de la iglesia, casa blanca con portón negro">@Model.DIRECCION_COMPLETA</textarea>
                            <div id="error-direccion" class="hidden mt-1 text-xs text-red-600">
                                La dirección es obligatoria (mínimo 10 caracteres)
                            </div>
                        </div>

                        <div class="mb-4 mt-6 h-px w-full bg-gray-200"></div>

                        <h3 class="mb-2 text-lg font-medium text-gray-800">Cambiar Contraseña</h3>
                        <p class="mb-4 text-sm text-gray-500">Deje estos campos en blanco si no desea cambiar su contraseña actual.</p>

                        <div class="mb-6 grid grid-cols-1 gap-4 md:grid-cols-2">
                            <div class="relative">
                                <label for="Contrasena" class="mb-2 block text-sm font-medium text-gray-700">Nueva Contraseña</label>
                                <input type="password"
                                       class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                                       id="Contrasena"
                                       name="Contrasena"
                                       minlength="6"
                                       maxlength="50">

                                <div id="error-contrasena" class="hidden mt-1 text-xs text-red-600">
                                    La contraseña debe tener al menos 6 caracteres
                                </div>

                            </div>

                            <div class="relative">
                                <label for="confirmarContrasena" class="mb-2 block text-sm font-medium text-gray-700">Confirmar Nueva Contraseña</label>
                                <input type="password"
                                       class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:border-indigo-500 focus:outline-none focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                                       id="confirmarContrasena"
                                       name="confirmarContrasena"
                                       minlength="6"
                                       maxlength="50">
                                <div id="error-confirmar-contrasena" class="hidden mt-1 text-xs text-red-600">
                                    Las contraseñas no coinciden
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end">
                            <button type="submit" class="rounded-lg bg-gradient-to-r from-indigo-600 to-blue-500 px-6 py-2 font-medium text-white shadow-md transition hover:from-indigo-700 hover:to-blue-600">
                                <i class="fas fa-save mr-2"></i> Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Acciones rápidas -->
            <div class="overflow-hidden rounded-xl bg-white shadow-lg">
                <div class="bg-gradient-to-r from-indigo-600 to-blue-500 px-4 py-3 text-white">
                    <h2 class="font-bold">Acciones Rápidas</h2>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <a href="@Url.Action("MisPedidos", "Pedido")" class="flex items-center justify-center rounded-lg border border-indigo-500 bg-white px-4 py-3 font-medium text-indigo-600 transition hover:bg-indigo-50">
                            <i class="fas fa-shopping-bag mr-2"></i> Mis Pedidos
                        </a>
                        <a href="@Url.Action("MiCarrito", "Home")" class="flex items-center justify-center rounded-lg border border-green-500 bg-white px-4 py-3 font-medium text-green-600 transition hover:bg-green-50">
                            <i class="fas fa-shopping-cart mr-2"></i> Mi Carrito
                        </a>
                    </div>

                    @if (Model.ID_TIPO_USUARIO == 1)
                    {
                        <div class="mt-6 rounded-lg bg-blue-50 p-4 text-blue-800">
                            <h3 class="mb-2 text-lg font-semibold">Acceso de Administrador</h3>
                            <p class="mb-4">Tiene acceso a funciones administrativas del sistema.</p>
                            <div class="h-px w-full bg-blue-200"></div>
                            <div class="mt-4">
                                <a href="@Url.Action("Dashboard", "Home")" class="inline-flex items-center rounded-lg bg-blue-500 px-6 py-2 font-medium text-white transition hover:bg-blue-600">
                                    <i class="fas fa-tachometer-alt mr-2"></i> Ir al Dashboard
                                </a>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/Usuario.js"></script>
}